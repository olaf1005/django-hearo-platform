(function(n){function d(){}jQuery.event.props.push("dataTransfer");var u={fallback_id:"",url:"",refresh:1E3,paramname:"userfile",allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:d,dragEnter:d,dragOver:d,dragLeave:d,docEnter:d,docOver:d,docLeave:d,beforeEach:d,afterAll:d,rename:d,error:function(){},uploadStarted:d,uploadFinished:d,progressUpdated:d,speedUpdated:d},k=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed"],i,q=!1,j=0,
e;n.fn.filedrop=function(d){function t(b,d,e,h){var a="";if(c.data){var j=n.param(c.data).split(/&/);n.each(j,function(){var b=this.split(/=/,2),c=decodeURIComponent(b[0]),b=decodeURIComponent(b[1]);a+="--";a+=h;a+="\r\n";a+='Content-Disposition: form-data; name="'+c+'"';a+="\r\n";a+="\r\n";a+=b;a+="\r\n"})}a+="--";a+=h;a+="\r\n";a+='Content-Disposition: form-data; name="'+c.paramname+'"';a+='; filename="'+b+'"';a+="\r\n";a+="Content-Type: "+e;a+="\r\n";a+="\r\n";a+=d;a+="\r\n";a+="--";a+=h;a+="--";
return a+="\r\n"}function v(b){if(b.lengthComputable){var d=Math.round(100*b.loaded/b.total);if(this.currentProgress!=d){this.currentProgress=d;c.progressUpdated(this.index,this.file,this.currentProgress);var d=(new Date).getTime(),e=d-this.currentStart;e>=c.refresh&&(c.speedUpdated(this.index,this.file,(b.loaded-this.startData)/e),this.startData=b.loaded,this.currentStart=d)}}}function l(){q=!1;if(!e)return c.error(k[0]),!1;var b=0,d=0;if(j>c.maxfiles&&0===c.queuefiles)return c.error(k[1]),!1;for(var i=
[],h=[],a=[],o=0;o<j;o++)i.push(o);var r=function(){var a;if(q)return!1;if(0<c.queuefiles&&h.length>=c.queuefiles)setTimeout(r,c.queuewait);else{a=i[0];i.splice(0,1);h.push(a);try{if(!1!=c.beforeEach(e[a])){if(a!==j){var b=new FileReader,g=1048576*c.maxfilesize;b.index=a;if(e[a].size>g)return c.error(k[2],e[a],a),h.forEach(function(b,c){b===a&&h.splice(c,1)}),d++,!0;b.onloadend=!c.beforeSend?l:function(b){c.beforeSend(e[a],a,function(){l(b)})};b.readAsBinaryString(e[a])}}else d++}catch(m){return h.forEach(function(b,
c){b===a&&h.splice(c,1)}),c.error(k[0]),!1}}},l=function(f){console.log("send",f);var o=("undefined"===typeof f.srcElement?f.target:f.srcElement).index;void 0==f.target.index&&(f.target.index=w(f.total));var g=new XMLHttpRequest,m=g.upload,p=e[f.target.index],k=f.target.index,l=(new Date).getTime(),s="------multipartformboundary"+(new Date).getTime();c.uploadStarted(k,p,j);m.addEventListener("progress",function(a){n(".sl-upload-bar").val(a.loaded/a.total*100).trigger("change")},!1);newName=c.rename(p.name);
mime=p.type;f="string"===typeof newName?t(newName,f.target.result,mime,s):t(p.name,f.target.result,mime,s);m.index=k;m.file=p;m.downloadStartTime=l;m.currentStart=l;m.currentProgress=0;m.startData=0;m.addEventListener("progress",v,!1);g.open("POST",c.url,!0);g.setRequestHeader("content-type","multipart/form-data; boundary="+s);n.each(c.headers,function(a,b){g.setRequestHeader(a,b)});g.sendAsBinary(f);g.onload=function(){if(g.responseText){var e=(new Date).getTime()-l,e=c.uploadFinished(k,p,jQuery.parseJSON(g.responseText),
e,g);b++;h.forEach(function(a,b){a===o&&h.splice(b,1)});a.push(o);i.length>0&&r();b==j-d&&c.afterAll();e===false&&(q=true)}g.status!=200&&c.error(g.statusText)}};r()}function w(b){for(var c=0;c<j;c++)if(e[c].size==b)return c}var c=n.extend({},u,d);this.on("drop",function(b){c.drop(b);e=b.dataTransfer.files;if(null===e||void 0===e)return c.error(k[0]),!1;j=e.length;l();b.preventDefault();return!1}).on("dragenter",function(b){clearTimeout(i);b.preventDefault();c.dragEnter(b)}).on("dragover",function(b){clearTimeout(i);
b.preventDefault();c.docOver(b);c.dragOver(b)}).on("dragleave",function(b){clearTimeout(i);c.dragLeave(b);b.stopPropagation()});n(document).on("drop",function(b){b.preventDefault();c.docLeave(b);return!1}).on("dragenter",function(b){clearTimeout(i);b.preventDefault();c.docEnter(b);return!1}).on("dragover",function(b){clearTimeout(i);b.preventDefault();c.docOver(b);return!1}).on("dragleave",function(b){i=setTimeout(function(){c.docLeave(b)},200)});n("#"+c.fallback_id).change(function(b){c.drop(b);
e=b.target.files;j=e.length;l()});return this};try{XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(d){d=Array.prototype.map.call(d,function(d){return d.charCodeAt(0)&255});this.send((new Uint8Array(d)).buffer)})}catch(x){}})(jQuery);
